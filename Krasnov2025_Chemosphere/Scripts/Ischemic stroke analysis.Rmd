---
title: "Ischemic stroke EHR"
author: "Helena Krasnov"
date: "2024-04-17"
output:
  pdf_document: default
  html_document: default
---
```{r include=FALSE}
#library(plyr)
library(dplyr)
library(mgcv)
library(data.table)
library(ggplot2)
library(table1)
library(plyr)
library(corrplot)
library(tableone)
```

# read the two databases
```{r}
EHR2 = readRDS('C:/Users/furmah01/OneDrive - The Mount Sinai Hospital/Helena/MSDW PC patients 2011-2023/generated files/EHR Data-Continuity/EHR2_gap.rds')
EHR3 = readRDS('C:/Users/furmah01/OneDrive - The Mount Sinai Hospital/Helena/MSDW PC patients 2011-2023/generated files/EHR Data-Continuity/EHR3_last.rds')

EHR2=EHR2 %>% mutate(sno = as.numeric(factor(MRN)))
EHR3=EHR3 %>% mutate(sno = as.numeric(factor(MRN)))
```

# Table 1: Descriptive statistics of population for EHR3 (last encounter model)
```{r eval=FALSE, include=FALSE}
my.render.cont <- function(x) {
    with(stats.default(x), 
         c("",
          "Mean (SD)" = sprintf("%s (%s)",
                                round_pad(MEAN, 2),
                                round_pad(SD, 2))))
}

my.render.cat <- function(x) { 
  sub('.', '.', c("", sapply(stats.default(x), 
  function(y) with(y, sprintf("%d (%0.2f %%)", FREQ, PCT)))), fixed = TRUE) 
}

year_followup3 = EHR3 %>% group_by(MRN)%>%slice(1)

year_followup3$male<-as.factor(year_followup3$male)
year_followup3$smoking<-as.factor(year_followup3$smoking)
year_followup3$insurance3<-as.factor(year_followup3$insurance3)
year_followup3$race5<-as.factor(year_followup3$race5)
year_followup3$Ischemic_stroke<-as.factor(year_followup3$Ischemic_stroke)
year_followup3$smoking = as.factor(year_followup3$smoking)

year_followup3$outcome = 'Descriptive Statistics'
table1(~ age + BMI2 +male + race5  +   Ischemic_stroke + pct_poverty + pct_black+ pct_NoHS + MEDHH + smoking | outcome , data=year_followup3,overall=F,render.continuous=my.render.cont, render.categorical=my.render.cat)

```

# population characteristic by EHR2
```{r eval=FALSE, include=FALSE}
quantile(EHR2$index, c(0.25,0.75),na.rm=TRUE)
EHR2$index_group = ifelse(EHR2$index >= 0.6,1,0)

year_followup2 = EHR2 %>% group_by(MRN)%>%slice(1)

year_followup2$male<-as.factor(year_followup2$male)
year_followup2$smoking<-as.factor(year_followup2$smoking)
year_followup2$insurance3<-as.factor(year_followup2$insurance3)
year_followup2$race5<-as.factor(year_followup2$race5)
year_followup2$Ischemic_stroke<-as.factor(year_followup2$Ischemic_stroke)

table1(~ race5  + male + BMI2 +pct_poverty + pct_black+ pct_NoHS + MEDHH + age | index_group , data=EHR2,overall=F,render.continuous=my.render.cont, render.categorical=my.render.cat)

```

#Define the components
```{r eval=FALSE, include=FALSE}
mixture = c("Br",  "Ca", "Cu",  "Fe", "K", "Ni", "Pb",  "Si", "V",   "Zn", "Ec",  "NH4", "NO3", "Oc","SO4")

# subscript
mixture2 <- c("Br",'Ca' ,"Cu", "Fe", 'K',"Ni", "Pb",'Si' ,"V", "Zn", "EC","$NH[4]","$NO[3]", "OC","$SO[4]")
```

# define components mixture and rename
```{r}
comp_mixture = c('X1_app' , 'X2_app' ,  'X3_app' , 'X4_app' , 'X5_app')

comp_mixture <- c("Biomass Burning","Oil Combustion","Metal Industry", "Other Industry",'Motor Vehicle & Resuspension of Dust')
```

#Figure 1- Correlations between the components
```{r eval=FALSE, include=FALSE}
corr_mix = c("Br",  "Ca", "Cu",  "Fe", "K", "Ni", "Pb",  "Si", "V",   "Zn", "Ec",  "NH4", "NO3", "Oc","SO4", 'X1_app' , 'X2_app' ,  'X3_app' , 'X4_app' , 'X5_app')

df_corr = subset(EHR3, select = (corr_mix))

output_file_path <- "C:/Users/furmah01/OneDrive - The Mount Sinai Hospital/Helena/MSDW PC patients 2011-2023/EHR Data-Continuity/Chemosphere Manuscript/Review/correlation_plot_new.png"
png(filename = output_file_path, width = 900, height = 800)

# Rename the columns to 
names(df_corr) <- c("Br",'Ca' ,"Cu", "Fe", 'K',"Ni", "Pb",'Si' ,"V", "Zn", "EC","$NH[4]","$NO[3]", "OC","$SO[4]","Biomass Burning","Oil Combustion","Metal Industry", "Other Industry",'MVRD')

# Calculate the correlation matrix
cor <- cor(df_corr, use = "complete.obs")

# Generate the corrplot with circle representation
corrplot(cor, type = "upper", method = 'circle', is.corr = TRUE, addCoef.col = "black")

dev.off()
```

# Table 2 - Descriptive statistics of components
```{r eval=FALSE, include=FALSE}
listvars=c('Br', 'Ca' ,'Cu', "Fe", "K", "Ni", "Pb", "Si", "V", "Zn", "Ec", "NH4", "NO3", "Oc", "SO4",'X1_app','X2_app','X3_app','X4_app','X5_app')

CreateTableOne(vars=listvars,data=EHR3)
```

# Supp figure 1 - nonliear dose response associations for components
```{r eval=FALSE, include=FALSE}
png("C:/Users/furmah01/OneDrive - The Mount Sinai Hospital/Helena/MSDW PC patients 2011-2023/EHR Data-Continuity/Chemosphere Manuscript/Review/spline_components_4factors.png",res=300,width=20,height=10,unit="in")

par(mfrow = c(3,5)) 

for (i in seq_along(mixture)) {
  
  comp <- mixture[i]
 
 form <- paste0(
    "Ischemic_stroke ~ s(", comp, ", bs='ps')+ as.factor(year) + as.factor(male) + as.factor(race5)  + as.factor(smoking)+ s(age)+ pct_poverty + pct_black + pct_NoHS+ MEDHH+s(sno,bs='re')")
 
  mod = bam(as.formula(form), data = EHR3, family = poisson)
  # Calculate 5th and 95th percentiles of 'comp'
  p1 <- quantile(EHR2[[comp]], 0.025,na.rm=TRUE)
  p2 <- quantile(EHR2[[comp]], 0.975,na.rm=TRUE)
  
  
  # Create the plot with custom axis labels
  plot(mod, select = 1, ylim = c(0, 2.5), xlim = c(p1, p2), trans = exp, xlab = mixture2[i], ylab = "RR (95% CI)",cex.lab=1.5, cex.axis=1.5)
    # Track progress
  cat("Progress:", i)
}
dev.off()
```

# Supp figure 1 - nonliear dose response associations for NMF
```{r}
# NMF
mod = bam(Ischemic_stroke ~ s(X1_app)+s(X2_app)+s(X3_app)+s(X4_app)+s(X5_app)+ as.factor(year) + as.factor(male) + as.factor(smoking)+ as.factor(race5)  + s(age)+ pct_poverty + pct_black + pct_NoHS+ MEDHH+s(sno,bs='re'), data = EHR3, family = poisson)

png("C:/Users/yitshm01/OneDrive - The Mount Sinai Hospital/Maayans lab/Helena/MSDW PC patients 2011-2023/EHR Data-Continuity/Chemosphere Manuscript/Review/spline_NMF_4factor.png",res=300,width=20,height=10,unit="in")
par(mfrow = c(2,3)) 

p1 <- quantile(EHR2$X1_app, 0.05,na.rm=TRUE)
p2 <- quantile(EHR2$X1_app, 0.995,na.rm=TRUE)
plot(mod,select=1,ylim = c(0, 2.5), xlim = c(p1, p2), trans = exp, xlab = 'Biomass Burning', ylab = "RR (95% CI)",cex.lab=1.5, cex.axis=1.5)

p1 <- quantile(EHR2$X2_app, 0.05,na.rm=TRUE)
p2 <- quantile(EHR2$X2_app, 0.995,na.rm=TRUE)
plot(mod,select=2,ylim = c(0, 2.5),  xlim = c(p1, p2),trans = exp, xlab = 'Oil Combustion', ylab = "RR (95% CI)",cex.lab=1.5, cex.axis=1.5)

p1 <- quantile(EHR2$X3_app, 0.05,na.rm=TRUE)
p2 <- quantile(EHR2$X3_app, 0.995,na.rm=TRUE)
plot(mod,select=3,ylim = c(0, 2.5),  xlim = c(p1, p2),trans = exp, xlab = 'Metal Industry', ylab = "RR (95% CI)",cex.lab=1.5, cex.axis=1.5)

p1 <- quantile(EHR2$X4_app, 0.05,na.rm=TRUE)
p2 <- quantile(EHR2$X4_app, 0.995,na.rm=TRUE)
plot(mod,select=4,ylim = c(0, 2.5),  xlim = c(p1, p2),trans = exp, xlab = 'Other Industry', ylab = "RR (95% CI)",cex.lab=1.5, cex.axis=1.5)

p1 <- quantile(EHR2$X5_app, 0.05,na.rm=TRUE)
p2 <- quantile(EHR2$X5_app, 0.995,na.rm=TRUE)
plot(mod,select=5,ylim = c(0, 2.5),  xlim = c(p1, p2),trans = exp, xlab = 'Motor Vehicle and \nResuspension of Dust', ylab = "RR (95% CI)",cex.lab=1, cex.axis=1)

dev.off()
```


# Main analysis comparing the EHR2 and 3 datasets, with and without adjustment for EHR continuity single components

# EHR3 last encounter model
```{r eval=FALSE, include=FALSE}
# No Br
mixture = c("Ca", "Cu",  "Fe", "K", "Ni", "Pb",  "Si", "V",   "Zn", "Ec",  "NH4", "NO3", "Oc","SO4")

table_comp = data.frame()

# Total number of iterations
total_iterations <- length(mixture)

for (i in seq_along(mixture)) {
  
  comp <- mixture[i]
  
  form1 = paste0("Ischemic_stroke ~",comp, "+ as.factor(year) + as.factor(male) + as.factor(race5)  + as.factor(smoking)+ s(age)+ pct_poverty + pct_black + pct_NoHS+ MEDHH+s(sno,bs='re')")
  mod1 = bam(as.formula(form1), data = EHR3, family = poisson)
  
  form2 = paste0("Ischemic_stroke ~", comp, " + as.factor(year) + as.factor(male) + as.factor(race5)  + as.factor(smoking)+s(age) + index + pct_poverty + pct_black + pct_NoHS + MEDHH+s(sno,bs='re')")
  mod2 = bam(as.formula(form2), data = EHR3, family = poisson)
  
  m_list <- list(mod1,mod2)
  table_results_1 = data.frame()

  for (j in seq_along(m_list)){
    mod = m_list[[j]]
    dust=summary(mod)$p.table
    dust<-as.data.frame(dust,keep.rownames = TRUE)[] # Format as datatable
    table_dust=dust[2,]
    
    # get upper and lower bound
    table_dust$lower = table_dust$Estimate - qnorm(0.975) * table_dust$`Std. Error`
    table_dust$upper = table_dust$Estimate + qnorm(0.975) * table_dust$`Std. Error`
    
    # exponentiate estimate and bounds
    table_dust$Estimate_exp <- exp(table_dust$Estimate*IQR(EHR3[[comp]],na.rm = TRUE))
    table_dust$lower_exp <- exp(table_dust$lower*IQR(EHR3[[comp]],na.rm = TRUE))
    table_dust$upper_exp <- exp(table_dust$upper*IQR(EHR3[[comp]],na.rm = TRUE))
    table_results_1 = rbind(table_results_1,table_dust)
  }
  
  table_results_1 = table_results_1[,-c(1:3,5:6) ]
  
  rownames(table_results_1) <- c("Last encounter models","Extended last encounter models")
  table_results_1$model <- rownames(table_results_1)
  
    table_results_1$exposure = comp
    
  
    table_comp = rbind(table_comp,table_results_1)
  
    # Track progress
  cat("Progress:", i, "out of", total_iterations, "\n")
}

row.names(table_comp) <- NULL
```

# Table 3: EHR2 two year gap model
```{r eval=FALSE, include=FALSE}
# No Br
table_comp2 = data.frame()

# Total number of iterations
total_iterations <- length(mixture)

for (i in seq_along(mixture)) {
  
  comp <- mixture[i]

  form3 = paste0("Ischemic_stroke ~", comp, " + as.factor(year) + as.factor(male) + as.factor(race5)  + as.factor(smoking)+s(age) + pct_poverty + pct_black + pct_NoHS+ MEDHH+s(sno,bs='re')")
  mod3 = bam(as.formula(form3), data = EHR2, family = poisson)

  form4 = paste0("Ischemic_stroke ~", comp, " + as.factor(year) + as.factor(male) + as.factor(race5) + as.factor(smoking)+s(age)+ index+ pct_poverty + pct_black + pct_NoHS+ MEDHH+s(sno,bs='re')")
  mod4 = bam(as.formula(form4), data = EHR2, family = poisson)
  
  m_list <- list(mod3,mod4)
  table_results_1 = data.frame()

  for (j in seq_along(m_list)){
    mod = m_list[[j]]
    dust=summary(mod)$p.table
    dust<-as.data.frame(dust,keep.rownames = TRUE)[] # Format as datatable
    table_dust=dust[2,]
    
    # get upper and lower bound
    table_dust$lower = table_dust$Estimate - qnorm(0.975) * table_dust$`Std. Error`
    table_dust$upper = table_dust$Estimate + qnorm(0.975) * table_dust$`Std. Error`
    
    # exponentiate estimate and bounds
    table_dust$Estimate_exp <- exp(table_dust$Estimate*IQR(EHR2[[comp]],na.rm = TRUE))
    table_dust$lower_exp <- exp(table_dust$lower*IQR(EHR2[[comp]],na.rm = TRUE))
    table_dust$upper_exp <- exp(table_dust$upper*IQR(EHR2[[comp]],na.rm = TRUE))
    table_results_1 = rbind(table_results_1,table_dust)
  }
  
  table_results_1 = table_results_1[,-c(1:3,5:6) ]
  
  rownames(table_results_1) <- c("Two year gap models", "Extended two-year gap models")
  table_results_1$model <- rownames(table_results_1)
  
    table_results_1$exposure = comp
    
  
    table_comp2 = rbind(table_comp2,table_results_1)
  
    # Track progress
  cat("Progress:", i, "out of", total_iterations, "\n")
}

row.names(table_comp2) <- NULL
```


# Applying correction for multiple tests to get p-adjusted value for table 3
```{r eval=FALSE, include=FALSE}
library(tidyverse)

table_comp_EHR2 = subset(table_comp2, model=="Two year gap models")
df_add_padj <- table_comp_EHR2 %>% mutate("adjusted p-value" = p.adjust(`Pr(>|z|)`, method="fdr", n=16))

#df_add_padj
```

# sources comperison models - last encounter
```{r}
variables <- c('X1_app',"X2_app", "X3_app", "X4_app", "X5_app")
iqrs <- sapply(variables, function(var) IQR(EHR3[[var]], na.rm = TRUE))

mod1 = bam(Ischemic_stroke ~ X1_app + X2_app +  X3_app + X4_app + X5_app + as.factor(year) +  as.factor(race5)  + as.factor(smoking)+ s(age)+ pct_poverty + pct_black + pct_NoHS+ MEDHH+s(sno,bs='re'), data = EHR3, family = poisson)

# with EHR index
mod2 = bam(Ischemic_stroke ~ X1_app +X2_app +  X3_app + X4_app + X5_app + as.factor(year) +  as.factor(race5)  + as.factor(smoking)+ s(age)+ pct_poverty + pct_black + pct_NoHS+ MEDHH + index+s(sno,bs='re') + index, data = EHR3, family = poisson)

  m_list <- list(mod1,mod2)
  table_results_1 = data.frame()

  for (j in seq_along(m_list)){
    mod = m_list[[j]]
    dust=summary(mod)$p.table
    dust<-as.data.frame(dust,keep.rownames = TRUE)[] # Format as datatable
    table_dust=dust[2:6,]
    
    # get upper and lower bound
    table_dust$lower = table_dust$Estimate - qnorm(0.975) * table_dust$`Std. Error`
    table_dust$upper = table_dust$Estimate + qnorm(0.975) * table_dust$`Std. Error`
    
    # exponentiate estimate and bounds
    table_dust$Estimate_exp <- exp(table_dust$Estimate*iqrs)
    table_dust$lower_exp <- exp(table_dust$lower*iqrs)
    table_dust$upper_exp <- exp(table_dust$upper*iqrs)
    rownames(table_dust) <- c('Biomass Burning',"Oil Combustion","Metal Industry", "Other Industry",'Motor Vehicle Resuspension of Dust')
    table_results_1 = rbind(table_results_1,table_dust)
  }
  table_results_1 = table_results_1[,-c(1:3,5:6) ]
  
  
table_results_1$model[1:5] <- "Last encounter models"
table_results_1$model[6:10] <- "Extended last encounter models"

table_results_1$exposure = rownames(table_results_1)
row.names(table_results_1) <- NULL
table_results_1$exposure <- gsub("[0-9]+", "", table_results_1$exposure)
```


# Table 4: sources comperison models - two year gap model
```{r}
iqrs2 <- sapply(variables, function(var) IQR(EHR2[[var]], na.rm = TRUE))

mod3 = bam(Ischemic_stroke ~ X1_app +X2_app +  X3_app + X4_app + X5_app + as.factor(year) +  as.factor(race5)  + as.factor(smoking)+ s(age)+ pct_poverty + pct_black + pct_NoHS+ MEDHH+s(sno,bs='re'), data = EHR2, family = poisson)

# with index
mod4 = bam(Ischemic_stroke ~ X1_app +X2_app +  X3_app + X4_app + X5_app + as.factor(year) +  as.factor(race5)  + as.factor(smoking)+ s(age)+ pct_poverty + pct_black + pct_NoHS+ MEDHH + index+s(sno,bs='re'), data = EHR2, family = poisson)

  m_list <- list(mod3,mod4)
  table_results_2 = data.frame()

  for (j in seq_along(m_list)){
    mod = m_list[[j]]
    dust=summary(mod)$p.table
    dust<-as.data.frame(dust,keep.rownames = TRUE)[] # Format as datatable
    table_dust=dust[2:6,]
    
    # get upper and lower bound
    table_dust$lower = table_dust$Estimate - qnorm(0.975) * table_dust$`Std. Error`
    table_dust$upper = table_dust$Estimate + qnorm(0.975) * table_dust$`Std. Error`
    
    # exponentiate estimate and bounds
    table_dust$Estimate_exp <- exp(table_dust$Estimate*iqrs2)
    table_dust$lower_exp <- exp(table_dust$lower*iqrs2)
    table_dust$upper_exp <- exp(table_dust$upper*iqrs2)
    rownames(table_dust) <- c('Biomass Burning',"Oil Combustion","Metal Industry", "Other Industry",'Motor Vehicle Resuspension of Dust')
    table_results_2 = rbind(table_results_2,table_dust)
  }
  table_results_2 = table_results_2[,-c(1:3,5:6) ]
  
  
table_results_2$model[1:5] <- "Two year gap models"
table_results_2$model[6:10] <- "Extended two-year gap models"


table_results_2$exposure = rownames(table_results_2)
row.names(table_results_2) <- NULL
table_results_2$exposure <- gsub("[0-9]+", "", table_results_2$exposure)
```

# Applying correction for multiple tests to get p-adjusted value for two year gap model and sources
```{r eval=FALSE, include=FALSE}
library(tidyverse)

table_comp_EHR2_nmf = subset(table_results_2, model=="Two year gap models")
df_add_padj <- table_comp_EHR2_nmf %>% mutate("adjusted p-value" = p.adjust(`Pr(>|z|)`, method="fdr", n=16))

df_add_padj
```


# Plot comperison of all 4 tables created: Fig 1
```{r}
df =do.call("rbind", list(table_comp,table_comp2, table_results_1,table_results_2))

df$exposure = ifelse(df$exposure == 'Ec','EC',df$exposure)
df$exposure = ifelse(df$exposure == 'Oc','OC',df$exposure)
# save for next rounds
write.csv(df,'C:/Users/furmah01/OneDrive - The Mount Sinai Hospital/Helena/MSDW PC patients 2011-2023/EHR Data-Continuity/Model_table.csv')
```

```{r}
df$model2 <- factor(df$model,levels = c("Extended last encounter models","Last encounter models", "Extended two-year gap models", "Two year gap models"))

df$group <- factor(df$exposure, 
                      levels = c("Ca", "Cu",  "Fe", "K", "Ni", "Pb",  "Si", "V",   "Zn", "EC",  "NH4", "NO3", "OC","SO4","Biomass Burning","Oil Combustion","Metal Industry", "Other Industry",'Motor Vehicle Resuspension of Dust'),
labels = c("Ca", "Cu",  "Fe", "K", "Ni", "Pb",  "Si", "V",   "Zn", "EC",  'NH4', 'NO3', "OC",'SO4',"Biomass Burning","Oil Combustion","Metal Industry", "Other Industry",'Motor Vehicle \nResuspension of Dust'))


tiff('C:/Users/furmah01/OneDrive - The Mount Sinai Hospital/Helena/MSDW PC patients 2011-2023/EHR Data-Continuity/Comperison_fig4.tiff', width = 12, height = 12, units = "in", res = 300)

# Create the plot
ggplot(df, aes(x = model2, y = Estimate_exp)) +
  geom_point() +
  geom_errorbar(aes(ymin = lower_exp, ymax = upper_exp), width = 0.1) +
  theme_minimal() +
  labs(x = "RR (95% CI)") +  # Set y-axis label
  coord_flip() +
  theme(legend.position = "none",
        axis.title.x = element_blank(),  # Remove x-axis title
        axis.title.y = element_text(size = 12),  # Increase y-axis title size
        axis.text.x = element_text(size = 12),
        axis.text.y  = element_text(size = 14),# Increase x-axis text size
        panel.spacing = unit(1, "lines"),  # Increase y-axis text size
        panel.border = element_rect(color = "black", fill = NA, size = 1),  # Add borders around panels
        strip.text.x = element_text(size = 12),  # Increase x-axis text size in facet labels
        strip.placement = "outside",  # Show x-axis labels in all facet boxes
        strip.background = element_rect(color = "black", fill = "white")) +  # Add background to facet labels
  facet_wrap(~ group,nrow = 5, ncol = 4) +  # Create separate plots for each pollutant
  geom_hline(aes(yintercept = 1), color = "blue") +
  scale_y_continuous(labels = scales::number_format(accuracy = 0.01))  # Limit x-axis labels to 2 decimals
dev.off()
```





